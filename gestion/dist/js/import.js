function mconfig(e){"use strict";$.ajax({url:"modeles/ajax/import/mconfig.php",type:"POST",dataType:"json",data:{sel:e},success:function(e){"Oui"==e.statut?($("#mconfig").show(),$("#malisteconfig").html(e.liste),malisteconfig):$("#mconfig").hide()}})}function tele(){"use strict";var e=$("#choix option:selected").val(),t="index.php?module=import&action=export&d="+e;window.open(t)}function traitementobser(e,t){"use strict";$.ajax({url:"modeles/ajax/import/importobser.php",type:"POST",dataType:"json",data:{fichier:t},success:function(a){"Oui"==a.statut&&($("#valajax1").hide(),$("#mes1").html('<div class="alert alert-success"" role="alert">'+e+" lignes ont été importées (de votre fichier "+t+").</div>"))}})}function calcimportfiche(e,t,a,i,s){"use strict";var r=0;progessbar=document.getElementById("BarFiche"),progessbar.value=r,progessbar.max=e,$("#BarFiche").show(),traitementfiche(e,r,t,a,i,s)}function calcimportsuivfiche(e,t,a,i,s,r,n){"use strict";if(t+a==e)progessbar.value=e,$("#BarFiche").hide(),$("#mes2").html('<div class="alert alert-success" role="alert">'+e+" lignes ont été importées</div>");else{var o=s;progessbar.value=t,t+=a,traitementfiche(e,t,o,i,r,n)}}function traitementfiche(e,t,a,i,s,r){"use strict";$.ajax({url:"modeles/ajax/import/importfiche.php",type:"POST",dataType:"json",data:{nbdeb:a,fichier:i,datef:s,biogeo:r},success:function(a){"Oui"==a.statut&&calcimportsuivfiche(e,t,a.nb,i,a.derniere,s,r)}})}function conversion_seconde_heure(e){var t=e,a="",i=Math.floor(t/86400);t-=24*i*3600;var s=Math.floor(t/3600);t-=3600*s;var r=Math.floor(t/60);t-=60*r;var n=t;return i>0&&(a=a+i+"j "),s>0&&(a=a+s+" h "),r>0&&(a=a+r+" min "),n>0&&(a=a+n+" s "),a}function calcimportobs(e,t,a){"use strict";var i=0,s=0,r="",n=0;progessbar=document.getElementById("BarFiche"),progessbar.value=i,progessbar.max=e,$("#BarFiche").show(),$("#InfoFiche").show(),$("#InfoFiche").html(" "+i+" ligne"),traitementobs(e,s,i,t,a,r,n)}function calcimportsuivobs(e,t,a,i,s,r,n,o,l,c){"use strict";if(0==$("#idobsdeb").val()&&$("#idobsdeb").val(l),a+i==e){progessbar.value=e,$("#idobsfin").val(c),$("#InfoFiche").hide();var u=e-o;e!=u?$("#mes2").html('<div class="alert alert-success" role="alert">'+e+" lignes ont été traitées. "+u+" ont été importées. Vérification des doublons en cours</div>"):$("#mes2").html('<div class="alert alert-success" role="alert">'+e+" lignes ont été traitées et importées. Vérification des doublons en cours</div>"),""!=n&&$("#mescdref").html('<div class="alert alert-danger" role="alert"><p><a href="tmp/errimport.csv">Télécharger le fichier des lignes à vérifier</a><br><b>Erreur. Problème de cdnom et/ou cdref (ou de caractères spéciaux dans le champ remarque). Ces lignes n\'ont pas éte importées : </b><br>'+n+"</div>"),verifligne(),histo()}else{var m=r;progessbar.value=a,$("#InfoFiche").html(" "+a+" lignes"),a+=i,traitementobs(e,t,a,m,s,n,o)}}function traitementobs(e,t,a,i,s,r,n){"use strict";$.ajax({url:"modeles/ajax/import/importobs.php",type:"POST",dataType:"json",data:{nbdeb:i,nbligne:t,fichier:s,mescdref:r,nber:n},success:function(t){"Oui"==t.statut&&calcimportsuivobs(e,t.nbligne,a,t.nb,s,t.derniere,t.mescdref,t.nber,t.prem,t.dern)}})}function histo(){"use strict";var e=$("#idm").val(),t=$("#idobsdeb").val(),a=$("#idobsfin").val(),i=$("#nomimp").val();$("#idobsfin").val(""),$("#idobsdeb").val(0),$.ajax({url:"modeles/ajax/import/importhisto.php",type:"POST",dataType:"json",data:{idm:e,prem:t,dern:a,desc:i},success:function(e){"Oui"!=e.statut&&alert("Problème pour enregistrer historique")}})}function verifligne(){"use strict";$("#valajax2").show();var e=$("#idobsdeb").val(),t=$("#idobsfin").val();$.ajax({url:"modeles/ajax/import/verifligne.php",type:"POST",dataType:"json",data:{prem:e,dern:t},success:function(e){"Oui"==e.statut?($("#valajax2").hide(),$("#mes2").append('<div class="alert alert-success" role="alert">Vérification des doublons et intégrité des observations finit, ('+e.nb+" doublons traités)</div>")):(alert("Problème dans les verifications de doublons"),$("#valajax2").hide())}})}function importautre(e){"use strict";var t=$("#condi").val(),a=new FormData(e[0]);a.append("condi",t);var i=a;$("#mes1").html(""),$("#meser").html(""),$("#valajax1").show(),$.ajax({url:"modeles/ajax/import/importautredeb.php",type:"POST",dataType:"json",data:i,contentType:!1,processData:!1,success:function(e){if("Oui"==e.statut){$("#mes1").html(e.nb+" lignes dans votre fichier "+e.nomfichier+". Aucune erreur n'a été détectée. Import des données en cours.");var a=0;calcimportautre(e.nb,a,e.nomfichier,e.choix,t)}else $("#mes1").html(e.mes);$("#valajax1").hide()}})}function calcimportautre(e,t,a,i,s){"use strict";var r=0,n=0,o="",l=0;progessbar=document.getElementById("BarFiche"),progessbar.value=r,progessbar.max=e,$("#BarFiche").show(),$("#InfoFiche").show(),$("#InfoFiche").html(" "+r+" ligne"),traitementautre(e,n,r,t,a,o,l,i,s)}function calcimportsuivautre(e,t,a,i,s,r,n,o,l,c){"use strict";if(a+i==e){progessbar.value=e,$("#InfoFiche").hide();var u=e-o;e!=u?$("#mes1").html('<div class="alert alert-success" role="alert">'+e+" lignes ont été traitées. "+u+" ont été importées.</div>"):$("#mes1").html('<div class="alert alert-success" role="alert">'+e+" lignes ont été traitées et importées.</div>"),""!=n&&$("#meser").html('<div class="alert alert-danger" role="alert"><b>Les id-origine des lignes suivante de votre fichier n\'ont pas été trouvés :</b> '+n+" Ces lignes n'ont pas éte importées</div>")}else{var m=r;progessbar.value=a,$("#InfoFiche").html(" "+a+" lignes"),a+=i,traitementautre(e,t,a,m,s,n,o,l,c)}}function traitementautre(e,t,a,i,s,r,n,o,l){"use strict";$.ajax({url:"modeles/ajax/import/importautre.php",type:"POST",dataType:"json",data:{nbdeb:i,nbligne:t,fichier:s,meser:r,nber:n,choix:o,condi:l},success:function(t){"Oui"==t.statut?calcimportsuivautre(e,t.nbligne,a,t.nb,s,t.derniere,t.meser,t.nber,o,l):$("#mes1").html(t.mes)}})}$(document).ready(function(){"use strict";$("#valajax1").hide(),$("#valajax2").hide(),$("#expli").hide(),$("#BarFiche").hide(),$("#mconfig").hide()}),$("#choix").change(function(){"use strict";$("#mes1").html("");var e=$("#choix option:selected").val();"NR"!==e?($("#sel").val(e),mconfig(e)):($("#sel").val(""),$("#mconfig").hide())}),$("#importliste").on("submit",function(e){"use strict";e.preventDefault();var t=$(this),a=window.FormData?new FormData(t[0]):null,i=null!==a?a:t.serialize();$("#valajax1").show(),$.ajax({url:"modeles/ajax/import/importliste.php",type:"POST",dataType:"json",data:i,contentType:!1,processData:!1,success:function(e){"Oui"==e.statut?($("#valajax1").hide(),$("#mes1").html('<div class="alert alert-success" role="alert"><p>Vous avez importé une liste de <b>'+e.nb+"</b> taxons<br />Pour <b>"+e.nbok+"</b> un cdnom a pu être attribué.<br />Pour <b>"+e.nbpr+"</b> plusieurs cdnom peuvent-être attribué (à vérifier)<br />Pour <b>"+e.nbno+'</b> aucun cdnom a pu être attribué.</p><p class="curseurlien" onclick="tele()"><b>Exporter les csv</b></p></div>')):($("#mes1").html(e.mes),$("#valajax1").hide())}})}),$("#importobser").on("submit",function(e){"use strict";e.preventDefault();var t=$(this),a=window.FormData?new FormData(t[0]):null,i=null!==a?a:t.serialize();$("#valajax1").show(),$.ajax({url:"modeles/ajax/import/importobserdeb.php",type:"POST",dataType:"json",data:i,contentType:!1,processData:!1,success:function(e){"Oui"==e.statut?traitementobser(e.nb,e.nomfichier):($("#mes1").html(e.mes),$("#valajax1").hide())}})}),$("#bttftpfiche").click(function(){"use strict";var e=$("#nomftpfiche").val(),t=$("input[name=cdate]:checked").val();""===e?$("#mes2").html('<div class="alert alert-danger" role="alert">Aucun nom de fichier indiqué</div>'):($("#mes2").html(""),$("#valajax2").show(),$.ajax({url:"modeles/ajax/import/importfichedeb.php",type:"POST",dataType:"json",data:{ftp:e,cdate:t},success:function(e){if("Oui"==e.statut){$("#valajax2").hide(),$("#mes2").html(e.nb+" lignes dans votre fichier "+e.nomfichier+". Aucune erreur n'a été détectée. Import des données en cours.");var t=0,a=$("#biogeo").val();calcimportfiche(e.nb,t,e.nomfichier,e.date,a)}else $("#mes2").html(e.mes),$("#valajax2").hide()}}))}),$("#importfiche").on("submit",function(e){"use strict";e.preventDefault();var t=$(this),a=window.FormData?new FormData(t[0]):null,i=null!==a?a:t.serialize();$("#valajax2").show(),$.ajax({url:"modeles/ajax/import/importfichedeb.php",type:"POST",dataType:"json",data:i,contentType:!1,processData:!1,success:function(e){if("Oui"==e.statut){$("#valajax2").hide(),$("#mes2").html(e.nb+" lignes dans votre fichier "+e.nomfichier+". Aucune erreur n'a été détectée. Import des données en cours.");var t=0,a=$("#biogeo").val();calcimportfiche(e.nb,t,e.nomfichier,e.date,a)}else $("#mes2").html(e.mes),$("#valajax2").hide()}})});var maxbar,progessbar;$("#bttftp").click(function(){"use strict";if(""==$("#nomimp").val())$("#mes2").html('<div class="alert alert-danger" role="alert">Indiquer la provenance des données</div>');else{var e=$("#nomftp").val();""===e?$("#mes2").html('<div class="alert alert-danger" role="alert">Aucun nom de fichier indiqué</div>'):($("#mes2").html(""),$("#valajax2").show(),$.ajax({url:"modeles/ajax/import/importobsdeb.php",type:"POST",dataType:"json",data:{ftp:e},success:function(e){if("Oui"==e.statut){if($("#valajax2").hide(),e.nb<=500)var t="";else var a=Math.ceil(e.nb/500),i=1.5*a,s=conversion_seconde_heure(i),t=" Temps de traitement estimé à "+s;$("#mes2").html(e.nb+" lignes dans votre fichier "+e.nomfichier+". Aucune erreur n'a été détectée. Import des données en cours."+t);var r=0;calcimportobs(e.nb,r,e.nomfichier)}else $("#mes2").html(e.mes),$("#valajax2").hide()}}))}}),$("#importobs").on("submit",function(e){"use strict";if(e.preventDefault(),""!=$("#nomimp").val()){var t=$(this),a=window.FormData?new FormData(t[0]):null,i=null!==a?a:t.serialize();$("#valajax2").show(),$("#mes2").html(""),$.ajax({url:"modeles/ajax/import/importobsdeb.php",type:"POST",dataType:"json",data:i,contentType:!1,processData:!1,success:function(e){if("Oui"==e.statut){if($("#valajax2").hide(),e.nb<=500)var t="";else var a=Math.ceil(e.nb/500),i=1.5*a,s=conversion_seconde_heure(i),t=" Temps de traitement estimé à "+s;$("#mes2").html(e.nb+" lignes dans votre fichier "+e.nomfichier+". Aucune erreur n'a été détectée. Import des données en cours."+t);var r=0;calcimportobs(e.nb,r,e.nomfichier)}else $("#mes2").html(e.mes),$("#valajax2").hide()}})}else $("#mes2").html('<div class="alert alert-danger" role="alert">Indiquer la provenance des données</div>')}),$("#maintenance").change(function(){"use strict";var e=$("#maintenance").val();$.ajax({url:"modeles/ajax/maintenance.php",type:"POST",dataType:"json",data:{choix:e},success:function(e){"Oui"!=e.statut&&alert("Problème !")}})}),$(".sel").click(function(){"use strict";var e=$(this).parent().parent().attr("id"),t=$("#"+e).find(".mini").html(),a=$("#"+e).find(".max").html(),i=$("#"+e).find(".descri").html(),s=$("#condi").val(),r=$("#labcondi").val();""==s?($("#condi").val(" (idobs >="+t+" AND idobs <="+a+")"),$("#labcondi").val("Uniquement les id origine de : "+i)):($("#condi").val(s+" OR (idobs >="+t+" AND idobs <="+a+")"),$("#labcondi").val(r+" et : "+i))}),$("#importplte").on("submit",function(e){"use strict";e.preventDefault();var t=$(this);importautre(t)}),$("#importcoll").on("submit",function(e){"use strict";e.preventDefault();var t=$(this);importautre(t)}),$("#importhab").on("submit",function(e){"use strict";e.preventDefault();var t=$(this);importautre(t)}),$("#importmort").on("submit",function(e){"use strict";e.preventDefault();var t=$(this);importautre(t)}),$("#importpiaf").on("submit",function(e){"use strict";e.preventDefault();var t=$(this);importautre(t)}),$("#importcom").on("submit",function(e){"use strict";e.preventDefault();var t=$(this);importautre(t)}),$("#importphoto").on("submit",function(e){"use strict";e.preventDefault();var t=$(this);importautre(t)});