/**
 * Plugin Name: Glossarizer
 * Author : Vinay @Pebbleroad
 * Date: 02/04/2013
 * Description: Takes glossary terms from a JSON object -> Searches for terms in your html -> Wraps a abbr tag around the matched word
 * 1. Fixed IE8 bug where whitespace get removed - Had to change `abbr` tag to a block element `div`
 */
!function(e){function t(t,r){var s=this;s.el=t,s.$el=e(t),s.options=e.extend({},i,r),s.terms=[],s.excludes=[],s.replaced=[],s.regexOption=(s.options.caseSensitive?"":"i")+(s.options.replaceOnce?"":"g"),e.getJSON(this.options.sourceURL).then(function(e){if(s.glossary=e,s.glossary.length&&0!=s.glossary.length){for(var t=0;t<s.glossary.length;t++)for(var r=s.glossary[t].term.split(","),i=0;i<r.length;i++){var a=r[i].replace(/^\s+|\s+$/g,""),n=a.indexOf("!");n==-1||0!=n?s.terms.push(a):s.excludes.push(a.substr(1))}s.wrapTerms()}})}function r(t,r,s){if("string"!=typeof t)return e.inArray.apply(this,arguments);if(r){var i=r.length;for(s=s?s<0?Math.max(0,i+s):s:0,t=t.toLowerCase();s<i;s++)if(s in r&&r[s].toLowerCase()==t)return s}return-1}var s="glossarizer",i={sourceURL:"",replaceTag:"abbr",lookupTagName:"p, ul, a, div",callback:null,replaceOnce:!1,replaceClass:"glossarizer_replaced",caseSensitive:!1};t.prototype={getDescription:function(e){for(var t=new RegExp("(,|s*)"+this.clean(e)+"\\s*|\\,$","i"),r=0;r<this.glossary.length;r++)if(this.glossary[r].term.match(t))return this.glossary[r].description.replace(/\"/gi,"&quot;")},clean:function(e){var t=new RegExp("(\\"+["/",".","*","+","?","(",")","[","]","{","}","\\"].join("|\\")+")","g");return e.replace(t,"\\$1")},wrapTerms:function(){this.cleanedTerms=this.clean(this.terms.join("|")),this.excludedTerms=this.clean(this.excludes.join("|"));for(var e=this.el.querySelectorAll(this.options.lookupTagName),t=0;t<e.length;t++)this.traverser(e[t]);this.options.callback&&this.options.callback.call(this.$el)},traverser:function(t){var s,i=this;if(1===t.nodeType){if(t=t.firstChild)do s=t.nextSibling,t.className!=this.options.replaceClass&&this.traverser(t);while(t=s)}else if(3===t.nodeType){var a=document.createElement("div"),n=t.data,o=new RegExp("(?:^|\\b)("+this.cleanedTerms+")(?!\\w)",i.regexOption),l=new RegExp("(?:^|\\b)("+this.excludedTerms+")(?!\\w)",i.regexOption);if(o.test(n)){var p=l.exec(n);for(n=n.replace(o,function(e,t,s,a){if(i.options.replaceOnce&&r(e,i.replaced)>=0)return e;i.replaced.push(e);var o=new RegExp("(?:^|\\b)"+i.clean(e)+"(?!\\w)"),l=o.exec(n);if(l){if(p&&i.excludes.length){var c=s,h=p.index,g=p.index+p[0].length;return h<=c&&c<=g?e:"<"+i.options.replaceTag+' class="'+i.options.replaceClass+'" data-toggle="tooltip" data-placement="top" title="'+i.getDescription(e)+'">'+e+"</"+i.options.replaceTag+">"}return"<"+i.options.replaceTag+' class="'+i.options.replaceClass+'" data-toggle="tooltip" data-placement="top" title="'+i.getDescription(e)+'">'+e+"</"+i.options.replaceTag+">"}}),e(a).html(n);a.firstChild;)t.parentNode.insertBefore(a.firstChild,t);t.parentNode.removeChild(t)}}}};var a={destroy:function(){this.$el.removeData("plugin_"+s),this.$el.find("."+this.options.replaceClass).each(function(){var t=e(this),r=t.text();t.replaceWith(r)})}};t.prototype=e.extend({},t.prototype,a),e.fn[s]=function(r){return this.each(function(){var i=e(this),n=i.data("plugin_"+s);"string"==typeof r&&n&&a.hasOwnProperty(r)?n[r].apply(n):(n&&n.destroy.apply(n),e.data(this,"plugin_"+s,new t(this,r)))})}}(jQuery);