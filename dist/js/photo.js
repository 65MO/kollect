function rechercheobs(){"use strict";var e=$("#idobs").val(),o=$("#idm").val();$.ajax({url:"modeles/ajax/photo/chercherobs.php",type:"POST",dataType:"json",data:{idobs:e,idm:o},success:function(e){if("Oui"==e.statut)if("Oui"==e.er)$("#mesverif").html('<p class="text-danger">Vous êtes pas enregistré comme observateur pour cette donnée !</p>'),$("#commune").val(""),$("#codecom").val(""),$("#espece").val(""),$("#cdnom").val(""),$("#date").val(""),$("#stade option").remove(),$("#stade").val(""),$("#commune").prop("disabled",!1).css("cursor","auto"),$("#espece").prop("disabled",!1).css("cursor","auto"),$("#date").prop("disabled",!1).css("cursor","auto"),$("#idobs").val(""),$("#BttV").hide();else{if($("#mesverif").html(""),$("#idobser").val(e.idobser),$("#commune").val(e.data.commune),$("#codecom").val(e.data.codecom),$("#espece").val(e.data.nom+" ("+e.data.nomvern+")"),$("#cdnom").val(e.data.cdnom),$("#date").val(e.data.datefr),""!=e.stade){var o;$.each(e.stade,function(e,t){o+="<option value="+t+">"+e+"</option>"}),$("#stade").html(o),$("#stade").focus(),rphoto1(e.data.cdnom,e.data.observa)}$("#commune").prop("disabled",!0).css("cursor","Not-Allowed"),$("#espece").prop("disabled",!0).css("cursor","Not-Allowed"),$("#date").css("cursor","Not-Allowed")}else alert("problème...")}})}function rphoto1(e,o){"use strict";$("#obser").val(o),$.ajax({url:"modeles/ajax/photo/listephoto.php",type:"POST",dataType:"json",data:{cdnom:e,nomvar:o},success:function(e){var t=$("#espece").val();if(0==e.nb)$("#ordreph").val(1),$("#nomphoto").val(o+e.time),$("#nbphoto").html('<p class="text-info"><b>Première photo de '+t+" sur le site</b></p>");else{var a=parseInt(e.nb)+1;$("#ordreph").val(a),$("#nomphoto").val(o+e.time),$("#nbphoto").html('<p class="text-info"><b>'+a+"ème photos de "+t+" sur le site</b></p>")}$("#nouv").val("non")}})}function rphoto(e,o){"use strict";""!=$("#cdnom").val()&&$.ajax({url:"modeles/ajax/photo/listephotom.php",type:"POST",dataType:"json",data:{cdnom:e,nomvar:o},success:function(e){$("#obser").val(o);var t=$("#espece").val();if(0==e.nb)$("#ordreph").val(1),$("#nomphoto").val(o+e.time),$("#nbphoto").html('<p class="text-info"><b>Première photo de '+t+" sur le site</b></p>");else{var a=parseInt(e.nb)+1;$("#ordreph").val(a),$("#nomphoto").val(o+e.time),$("#nbphoto").html('<p class="text-info"><b>'+a+"ème photos de "+t+" sur le site</b></p>")}if(""!=e.stade){var s;$.each(e.stade,function(e,o){s+="<option value="+o+">"+e+"</option>"}),$("#messtade").html(""),$("#stade").html(s)}else $("#stade option").remove(),$("#messtade").html('<p class="text-danger">Aucun stade de définit pour l\'observatoire <b>'+o+"</b> ! Contacter un administrateur du site.</p>");$("#nouv").val("non")}})}function verif(){"use strict";var e=$("#cdnom").val();if("oui"==$("#nouv").val()){var o=$("#obser").val();rphoto1(e,o),$("#BttV").show()}if(""==$("#idobs").val()){var t=$("#codecom").val(),a=$("#date").val(),s=$("#idm").val();$.ajax({url:"modeles/ajax/photo/verifobs1.php",type:"POST",dataType:"json",data:{cdnom:e,codecom:t,date:a,idm:s},success:function(e){if("Non"==e.statut)$("#BttV").hide(),"Oui"==e.er?$("#mesverif").html('<p class="text-danger">Le champ espèce ou commune ou date n\'est pas correctement rempli</p>'):($("#commune").val(""),$("#espece").val(""),$("#date").val(""),$("#mesverif").html('<p class="text-danger"><b>Aucune donnée référencée dans la base pour cette photo.</b><br>Vous devez au préalable saisir cette donnée dans la base afin de pouvoir mettre la photo.</p>'));else if($("#idobser").val(e.idobser),e.idobs)$("#mesverif").html(""),$("#idobs").val(e.idobs),$("#BttV").show();else if($("#idobs").val(""),e.site){$("#mesverif").html('<p class="text-danger">Il existe plusieurs données avec ces critères. Choisissez le bon site.</p>'),$("#site").show(),$("#BttV").hide();var o="<option value=>--Choisir un site--</option>";$.each(e.site,function(e,t){o+="<option value="+t.idobs+">"+t.site+"</option>"}),$("#site").html(o)}}})}else $("#BttV").show()}var dep;$(document).ready(function(){"use strict";$("#BttV").hide(),$("#valajax").hide(),$("#site").hide(),$("#nom").prop("disabled",!0).css("cursor","Not-Allowed"),$("#prenom").prop("disabled",!0).css("cursor","Not-Allowed"),$.getJSON("emprise/emprise.json",function(e){dep="oui"==e.contour2||"fr"==e.emprise?"oui":"non"});var e=$("#idobs").val();""!=e&&rechercheobs()}),$("input[name=orien]").change(function(){var e=$("input[name=orien]:checked").val();"paysage"==e?(w=400,h=266):(w=200,h=300),$("#crop").cropit("previewSize",{width:w,height:h})}),$(".rotate-cw").click(function(){$("#crop").cropit("rotateCW")}),$(".rotate-ccw").click(function(){$("#crop").cropit("rotateCCW")}),$("#crop").cropit({exportZoom:2,imageBackground:!0,imageBackgroundBorderWidth:40,width:400,height:266,onImageError:function(e){1===e.code&&($(".error-msg").html('<div class="alert alert-danger">Votre photo est trop petite</div>'),$("#BttV").hide())}}),$(".export").click(function(){$("#dia1").modal({backdrop:"static",show:!0,keyboard:!1});var e=$("#nomphoto").val();$("#prevdia1").html("Prévisualisation de "+e+".jpg");var o=$("#crop").cropit("export"),t=$('<img src="'+o+'" />');$("#imgdia1").html(t)}),$(".cropit-image-input").bind("change",function(){if(image=this.files[0],image.size/1048576>8)$(".error-msg").html('<div class="alert alert-danger">Votre photo fait plus de 8 M</div>');else{$(".error-msg").html("");var e=new FileReader;e.readAsDataURL(image),e.addEventListener("loadend",function(){$("#crop").cropit("imageSrc",e.result)}),$("#tele").html(""),verif()}}),$("#form_redim").submit(function(){$("#valajax").show();var e=$("#crop").cropit("export",{type:"image/jpeg",quality:.9,originalSize:!1});$(".hidden-image-data").val(e);var o=$(this).serialize();return $.ajax({url:"modeles/ajax/photo/inserphoto.php",type:"post",dataType:"json",data:o,success:function(e){"Oui"==e.statut?($("#tele").html('<p class="text-info"><b>Vous pouvez télécharger une nouvelle photo pour cette observation ou enregistrer une nouvelle photo en modifiant le formulaire.</b></p>'),$("#BttV").hide(),$("#site").hide(),$("#nouv").val("oui"),$(".cropit-preview-image").removeAttr("src"),$(".cropit-preview-background").removeAttr("src"),$(".hidden-image-data").val("")):$("#tele").html(e.mes),$("#valajax").hide()}}),!1}),$(function(){"use strict";$("#date").datepicker({changeMonth:!0,changeYear:!0,onClose:function(e){}})}),$("#commune").autocomplete({source:function(e,o){$.getJSON("modeles/ajax/listecommune.php",{term:e.term,dep:dep},function(e){o($.map(e,function(e){return"non"==dep?{label:e.commune,value:e}:{label:e.commune+" ("+e.departement+")",value:e}}))})},select:function(e,o){var t=o.item.value;return $("#commune").val(t.commune),$("#codecom").val(t.codecom),$("#messtade").html(""),!1}}),$("#espece").autocomplete({source:function(e,o){$.getJSON("modeles/ajax/liste.php",{term:e.term},function(e){o($.map(e,function(e){return{label:e.nom+" ("+e.nomvern+")",value:e}}))})},select:function(e,o){var t=o.item.value;return $("#espece").val(t.nom),$("#cdnom").val(t.cdnom),$("#obser").val(t.observatoire),rphoto(t.cdnom,t.observatoire),!1},change:function(e,o){o.item||($(this).val(""),$("#cdnom").val(""),$("#obser").val(""),$("#messtade").html('<p class="text-danger">L\'espèce doit-être présente dans la liste proposée.</p>'))}}),$("#idobs").change(function(){"use strict";rechercheobs()}),$("#site").change(function(){"use strict";var e=$("#site").val();$("#idobs").val(e),$("#BttV").show()});